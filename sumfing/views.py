from django.shortcuts import render
from django.shortcuts import redirect
import json
import datetime
import time
from django.views.decorators.csrf import csrf_protect


@csrf_protect
def index(request):

    today = datetime.date.today()
    today_str = today.strftime("%Y-%m-%d")

    puzzles = {'2024-10-01': {'Tiles': ['3', '5', '6', '8'], 'Easy': (24, ['8*3', '3*8']), 'Medium': (41, ['6+35', '36+5', '5+36', '35+6']), 'Hard': (113, ['6*5+83', '5*6+83', '83+5*6', '83+6*5']), 'Extra': (208, ['6^3-8'])}, '2024-10-02': {'Tiles': ['0', '1', '5', '6'], 'Easy': (21, ['16+5', '5+16', '15+6', '6+15']), 'Medium': (55, ['56-1', '60-5']), 'Hard': (101, ['106-5']), 'Extra': (210, ['6!-510'])}, '2024-10-03': {'Tiles': ['1', '2', '4', '9'], 'Easy': (6, ['4+2', '2+4']), 'Medium': (82, ['2*41', '41*2']), 'Hard': (151, ['9+142', '149+2', '2+149', '142+9']), 'Extra': (516, ['129*4', '4*129', '2^9+4', '4+2^9'])}, '2024-10-04': {'Tiles': ['0', '3', '4', '9'], 'Easy': (12, ['3+9', '9+3', '4*3', '3*4']), 'Medium': (66, ['4*9+30', '9*4+30', '30+4*9', '30+9*4']), 'Hard': (102, ['3*4+90', '4*3+90', '90+3*4', '90+4*3']), 'Extra': (144, ['3!^4/9'])}, '2024-10-05': {'Tiles': ['0', '1', '4', '8'], 'Easy': (20, ['80/4']), 'Medium': (31, ['4*8-1', '8*4-1']), 'Hard': (176, ['180-4']), 'Extra': (191, ['4!*8-1', '8*4!-1'])}, '2024-10-06': {'Tiles': ['1', '3', '5', '8'], 'Easy': (12, ['15-3']), 'Medium': (71, ['58+13', '18+53', '13+58', '53+18']), 'Hard': (163, ['31*5+8', '5*31+8', '8+31*5', '8+5*31']), 'Extra': (109, ['8*13+5', '13*8+5', '5+13*8', '5+8*13'])}, '2024-10-07': {'Tiles': ['0', '1', '2', '7'], 'Easy': (13, ['20-7']), 'Medium': (58, ['70-12']), 'Hard': (113, ['120-7']), 'Extra': (722, ['0!+721', '721+0!'])}, '2024-10-08': {'Tiles': ['1', '2', '4', '5'], 'Easy': (16, ['4+12', '2+14', '12+4', '21-5', '14+2']), 'Medium': (68, ['5*14-2', '14*5-2']), 'Hard': (107, ['54*2-1', '2*54-1']), 'Extra': (504, ['21*4!', '4!*21'])}, '2024-10-09': {'Tiles': ['1', '3', '6', '7'], 'Easy': (4, ['7-3', '3+1', '1+3']), 'Medium': (69, ['3+67-1', '63+7-1', '63-1+7', '3-1+67', '7+63-1', '67-1+3', '67+3-1', '7-1+63', '71-6/3']), 'Hard': (131, ['137-6']), 'Extra': (647, ['6!-73'])}, '2024-10-10': {'Tiles': ['0', '2', '8', '9'], 'Easy': (10, ['2+8', '8+2']), 'Medium': (87, ['89-2']), 'Hard': (199, ['208-9']), 'Extra': (106, ['2*8+90', '8*2+90', '90+2*8', '90+8*2'])}, '2024-10-11': {'Tiles': ['0', '6', '8', '9'], 'Easy': (2, ['8-6']), 'Medium': (66, ['8*9-6', '9*8-6']), 'Hard': (134, ['9*6+80', '6*9+80', '80+6*9', '80+9*6']), 'Extra': (688, ['689-0!'])}, '2024-10-12': {'Tiles': ['0', '7', '8', '9'], 'Easy': (16, ['9+7', '7+9']), 'Medium': (83, ['90-7']), 'Hard': (146, ['7*8+90', '8*7+90', '90+7*8', '90+8*7']), 'Extra': (727, ['80*9+7', '9*80+7', '8*90+7', '90*8+7', '7+80*9', '7+8*90', '7+90*8', '7+9*80'])}, '2024-10-13': {'Tiles': ['0', '3', '5', '6'], 'Easy': (8, ['5+3', '3+5']), 'Medium': (27, ['6*5-3', '5*6-3']), 'Hard': (126, ['630/5']), 'Extra': (483, ['603-5!'])}, '2024-10-14': {'Tiles': ['1', '2', '6', '9'], 'Easy': (5, ['6-1']), 'Medium': (97, ['6+91', '1+96', '91+6', '96+1']), 'Hard': (135, ['126+9', '6+129', '129+6', '9+126']), 'Extra': (732, ['12+6!', '6!+12'])}, '2024-10-15': {'Tiles': ['1', '6', '8', '9'], 'Easy': (12, ['96/8', '18-6']), 'Medium': (55, ['6*9+1', '9*6+1', '1+6*9', '1+9*6']), 'Hard': (188, ['196-8']), 'Extra': (497, ['61*8+9', '8*61+9', '9+61*8', '9+8*61'])}, '2024-10-16': {'Tiles': ['0', '2', '3', '7'], 'Easy': (15, ['30/2']), 'Medium': (68, ['70-2']), 'Hard': (105, ['30/2*7', '3/2*70', '70/2*3', '30*7/2', '7*30/2', '3*70/2', '70*3/2', '7/2*30']), 'Extra': (131, ['2^7+3', '3+2^7'])}, '2024-10-17': {'Tiles': ['1', '3', '4', '8'], 'Easy': (2, ['3-1', '8/4']), 'Medium': (87, ['3+84', '83+4', '4+83', '84+3']), 'Hard': (132, ['31*4+8', '4*31+8', '8+31*4', '8+4*31']), 'Extra': (312, ['4!*13', '13*4!'])}, '2024-10-18': {'Tiles': ['0', '1', '2', '6'], 'Easy': (19, ['20-1']), 'Medium': (96, ['102-6']), 'Hard': (114, ['120-6']), 'Extra': (700, ['6!-20'])}, '2024-10-19': {'Tiles': ['0', '1', '2', '4'], 'Easy': (23, ['24-1']), 'Medium': (38, ['40-2']), 'Hard': (106, ['2+104', '104+2', '102+4', '4+102']), 'Extra': (208, ['2*104', '104*2'])}, '2024-10-20': {'Tiles': ['4', '5', '7', '8'], 'Easy': (20, ['5*4', '4*5']), 'Medium': (31, ['7*5-4', '5*7-4']), 'Hard': (132, ['54+78', '47+85', '78+54', '45+87', '85+47', '74+58', '87+45', '58+74']), 'Extra': (809, ['4!+785', '785+4!'])}, '2024-10-21': {'Tiles': ['0', '3', '4', '5'], 'Easy': (8, ['5+3', '3+5']), 'Medium': (55, ['3*5+40', '5*3+40', '40+3*5', '40+5*3']), 'Hard': (197, ['4*50-3', '5*40-3', '40*5-3', '50*4-3']), 'Extra': (149, ['5^3+4!', '4!+5^3'])}, '2024-10-22': {'Tiles': ['1', '4', '5', '8'], 'Easy': (2, ['8/4']), 'Medium': (71, ['85-14']), 'Hard': (135, ['51+84', '81+54', '84+51', '54+81']), 'Extra': (479, ['5!*4-1', '4*5!-1'])}, '2024-10-23': {'Tiles': ['0', '2', '5', '7'], 'Easy': (9, ['7+2', '2+7']), 'Medium': (80, ['5*2+70', '2*5+70', '70+2*5', '70+5*2']), 'Hard': (107, ['5*20+7', '50*2+7', '20*5+7', '2*50+7', '7+20*5', '7+2*50', '7+50*2', '7+5*20']), 'Extra': (102, ['2^5+70', '70+2^5'])}, '2024-10-24': {'Tiles': ['1', '2', '4', '9'], 'Easy': (7, ['9-2']), 'Medium': (46, ['94/2-1']), 'Hard': (128, ['14*9+2', '9*14+2', '2+14*9', '2+9*14']), 'Extra': (838, ['2*419', '419*2'])}, '2024-10-25': {'Tiles': ['2', '3', '5', '8'], 'Easy': (11, ['8+3', '3+8']), 'Medium': (56, ['58-2']), 'Hard': (197, ['25*8-3', '8*25-3']), 'Extra': (712, ['832-5!'])}, '2024-10-26': {'Tiles': ['2', '4', '6', '9'], 'Easy': (11, ['9+2', '2+9']), 'Medium': (38, ['4*9+2', '9*4+2', '2+4*9', '2+9*4']), 'Hard': (157, ['942/6']), 'Extra': (222, ['942-6!', '9*4!+6', '4!*9+6', '9*24+6', '24*9+6', '6+24*9', '6+4!*9', '6+9*24', '6+9*4!'])}, '2024-10-27': {'Tiles': ['1', '2', '3', '5'], 'Easy': (10, ['5*2', '2*5']), 'Medium': (63, ['3*21', '21*3']), 'Hard': (133, ['135-2']), 'Extra': (192, ['2^5*3!', '312-5!', '3!*2^5'])}, '2024-10-28': {'Tiles': ['0', '1', '5', '9'], 'Easy': (6, ['1+5', '5+1']), 'Medium': (38, ['190/5']), 'Hard': (185, ['190-5']), 'Extra': (139, ['5!+19', '19+5!'])}, '2024-10-29': {'Tiles': ['2', '3', '7', '9'], 'Easy': (6, ['2*3', '3*2', '9-3']), 'Medium': (69, ['72-3']), 'Hard': (170, ['7*23+9', '23*7+9', '9+23*7', '9+7*23']), 'Extra': (585, ['2^9+73', '73+2^9'])}, '2024-10-30': {'Tiles': ['3', '4', '7', '8'], 'Easy': (15, ['7+8', '8+7']), 'Medium': (50, ['7+43', '47+3', '43+7', '3+47']), 'Hard': (145, ['38*4-7', '4*38-7']), 'Extra': (159, ['4*38+7', '3^4+78', '38*4+7', '78+3^4', '7+38*4', '7+4*38'])}, '2024-10-31': {'Tiles': ['0', '2', '5', '8'], 'Easy': (4, ['8/2']), 'Medium': (48, ['50-2']), 'Hard': (197, ['205-8']), 'Extra': (962, ['5!*8+2', '8*5!+2', '2+5!*8', '2+8*5!'])}, '2024-11-01': {'Tiles': ['0', '3', '4', '8'], 'Easy': (11, ['8+3', '3+8']), 'Medium': (62, ['4*8+30', '8*4+30', '30+4*8', '30+8*4']), 'Hard': (114, ['80+34', '30+84', '34+80', '84+30']), 'Extra': (128, ['8^3/4'])}, '2024-11-02': {'Tiles': ['2', '6', '7', '8'], 'Easy': (4, ['6-2', '8/2']), 'Medium': (70, ['2+68', '8+62', '62+8', '68+2']), 'Hard': (158, ['86+72', '76+82', '82+76', '72+86']), 'Extra': (392, ['7^2*8', '8*7^2'])}, '2024-11-03': {'Tiles': ['0', '1', '6', '7'], 'Easy': (9, ['16-7']), 'Medium': (77, ['6+71', '71+6', '76+1', '1+76']), 'Hard': (101, ['107-6']), 'Extra': (419, ['6*70-1', '70*6-1', '7*60-1', '60*7-1'])}, '2024-11-04': {'Tiles': ['1', '2', '3', '5'], 'Easy': (6, ['2*3', '3*2', '1+5', '5+1']), 'Medium': (99, ['2*51-3', '51*2-3']), 'Hard': (149, ['152-3']), 'Extra': (264, ['3^5+21', '21+3^5'])}, '2024-11-05': {'Tiles': ['5', '6', '7', '8'], 'Easy': (11, ['6+5', '5+6']), 'Medium': (94, ['658/7']), 'Hard': (100, ['8/6*75', '6*7+58', '7*6+58', '75/6*8', '75*8/6', '8*75/6', '58+6*7', '58+7*6']), 'Extra': (187, ['67+5!', '5!+67'])}, '2024-11-06': {'Tiles': ['0', '2', '4', '7'], 'Easy': (9, ['7+2', '2+7']), 'Medium': (39, ['70/2+4', '4+70/2']), 'Hard': (112, ['70+42', '40+72', '42+70', '72+40']), 'Extra': (152, ['2^7+4!', '4!+2^7'])}, '2024-11-07': {'Tiles': ['0', '6', '7', '9'], 'Easy': (16, ['9+7', '7+9']), 'Medium': (83, ['90-7']), 'Hard': (157, ['90+67', '67+90', '60+97', '97+60']), 'Extra': (132, ['6*7+90', '7*6+90', '90+6*7', '90+7*6'])}, '2024-11-08': {'Tiles': ['1', '2', '6', '9'], 'Easy': (18, ['9*2', '2*9']), 'Medium': (56, ['9*6+2', '6*9+2', '2+6*9', '2+9*6']), 'Hard': (188, ['91*2+6', '2*91+6', '6+2*91', '6+91*2']), 'Extra': (359, ['6!/2-1'])}, '2024-11-09': {'Tiles': ['1', '5', '6', '7'], 'Easy': (11, ['6+5', '5+6']), 'Medium': (55, ['56-1']), 'Hard': (171, ['176-5']), 'Extra': (705, ['6!-15'])}, '2024-11-10': {'Tiles': ['2', '4', '5', '8'], 'Easy': (1, ['5-4']), 'Medium': (89, ['84+5', '4+85', '5+84', '85+4']), 'Hard': (197, ['8*24+5', '24*8+5', '5+24*8', '5+8*24']), 'Extra': (801, ['825-4!'])}, '2024-11-11': {'Tiles': ['0', '4', '5', '6'], 'Easy': (14, ['56/4']), 'Medium': (29, ['6*4+5', '4*6+5', '5+4*6', '5+6*4']), 'Hard': (114, ['60+54', '50+64', '64+50', '54+60']), 'Extra': (160, ['5!+40', '40+5!'])}, '2024-11-12': {'Tiles': ['1', '3', '5', '9'], 'Easy': (6, ['9-3', '1+5', '5+1']), 'Medium': (86, ['91-5']), 'Hard': (138, ['9*15+3', '15*9+3', '3+15*9', '3+9*15']), 'Extra': (106, ['5*3+91', '3*5+91', '5^3-19', '91+3*5', '91+5*3'])}, '2024-11-13': {'Tiles': ['4', '5', '8', '9'], 'Easy': (2, ['8/4']), 'Medium': (68, ['8*9-4', '9*8-4']), 'Hard': (179, ['94+85', '84+95', '85+94', '95+84']), 'Extra': (919, ['895+4!', '4!+895'])}, '2024-11-14': {'Tiles': ['3', '4', '5', '7'], 'Easy': (10, ['7+3', '3+7']), 'Medium': (52, ['5+47', '47+5', '45+7', '7+45']), 'Hard': (109, ['34+75', '75+34', '35+74', '74+35']), 'Extra': (317, ['437-5!', '3^5+74', '74+3^5'])}, '2024-11-15': {'Tiles': ['0', '1', '6', '8'], 'Easy': (4, ['10-6']), 'Medium': (96, ['16+80', '86+10', '80+16', '10+86']), 'Hard': (152, ['160-8']), 'Extra': (815, ['816-0!'])}, '2024-11-16': {'Tiles': ['3', '4', '6', '7'], 'Easy': (21, ['3*7', '7*3']), 'Medium': (85, ['7*6+43', '3*7+64', '6*7+43', '7*3+64', '43+6*7', '43+7*6', '64+3*7', '64+7*3']), 'Hard': (154, ['37*4+6', '4*37+6', '6+37*4', '6+4*37']), 'Extra': (960, ['4*6!/3', '6!*4/3', '4/3*6!', '6!/3*4'])}, '2024-11-17': {'Tiles': ['0', '3', '4', '9'], 'Easy': (21, ['30-9']), 'Medium': (25, ['34-9']), 'Hard': (129, ['40*3+9', '3*40+9', '30*4+9', '4*30+9', '9+30*4', '9+3*40', '9+40*3', '9+4*30']), 'Extra': (102, ['3*4+90', '4*3+90', '90+3*4', '90+4*3'])}, '2024-11-18': {'Tiles': ['2', '4', '7', '9'], 'Easy': (18, ['9*2', '2*9']), 'Medium': (61, ['7*9-2', '9*7-2']), 'Hard': (154, ['2*79-4', '79*2-4']), 'Extra': (345, ['49*7+2', '7*49+2', '2+49*7', '2+7*49'])}, '2024-11-19': {'Tiles': ['3', '4', '6', '7'], 'Easy': (10, ['3+7', '6+4', '7+3', '4+6']), 'Medium': (94, ['376/4']), 'Hard': (147, ['47*3+6', '3*47+6', '6+3*47', '6+47*3']), 'Extra': (131, ['46*3-7', '4^3+67', '3*46-7', '67+4^3'])}, '2024-11-20': {'Tiles': ['0', '1', '2', '3'], 'Easy': (17, ['20-3']), 'Medium': (62, ['2*31', '31*2']), 'Hard': (128, ['130-2']), 'Extra': (124, ['123+0!', '0!+123'])}, '2024-11-21': {'Tiles': ['1', '2', '8', '9'], 'Easy': (20, ['2+18', '18+2', '12+8', '8+12']), 'Medium': (36, ['2*18', '18*2']), 'Hard': (187, ['189-2']), 'Extra': (353, ['19^2-8'])}, '2024-11-22': {'Tiles': ['3', '4', '5', '8'], 'Easy': (11, ['8+3', '3+8']), 'Medium': (87, ['4+83', '3+84', '84+3', '83+4']), 'Hard': (132, ['35*4-8', '4*35-8']), 'Extra': (168, ['5!+48', '48+5!'])}, '2024-11-23': {'Tiles': ['0', '1', '7', '9'], 'Easy': (16, ['9+7', '7+9']), 'Medium': (80, ['1+79', '9+71', '79+1', '71+9']), 'Hard': (161, ['170-9', '91+70', '70+91', '71+90', '90+71']), 'Extra': (916, ['917-0!'])}, '2024-11-24': {'Tiles': ['0', '1', '4', '9'], 'Easy': (5, ['9-4', '4+1', '1+4']), 'Medium': (86, ['90-4']), 'Hard': (113, ['109+4', '9+104', '4+109', '104+9']), 'Extra': (150, ['0!+149', '149+0!'])}, '2024-11-25': {'Tiles': ['1', '2', '8', '9'], 'Easy': (10, ['1+9', '9+1', '2+8', '8+2']), 'Medium': (87, ['89-2']), 'Hard': (171, ['2*81+9', '81*2+9', '9+2*81', '9+81*2']), 'Extra': (735, ['8*92-1', '92*8-1'])}, '2024-11-26': {'Tiles': ['1', '3', '8', '9'], 'Easy': (15, ['18-3']), 'Medium': (65, ['19*3+8', '3*19+8', '8+19*3', '8+3*19']), 'Hard': (109, ['9*13-8', '13*9-8']), 'Extra': (810, ['9^3+81', '81+9^3'])}, '2024-11-27': {'Tiles': ['4', '5', '7', '8'], 'Easy': (11, ['4+7', '7+4']), 'Medium': (79, ['5+74', '84-5', '75+4', '4+75', '74+5']), 'Hard': (105, ['58+47', '48+57', '57+48', '47+58']), 'Extra': (833, ['857-4!'])}, '2024-11-28': {'Tiles': ['1', '3', '6', '8'], 'Easy': (24, ['8*3', '3*8']), 'Medium': (89, ['6+83', '86+3', '83+6', '3+86']), 'Hard': (175, ['3*61-8', '61*3-8']), 'Extra': (518, ['8^3+6', '6+8^3'])}, '2024-11-29': {'Tiles': ['3', '5', '6', '9'], 'Easy': (1, ['6-5']), 'Medium': (84, ['5*3+69', '3*5+69', '69+3*5', '69+5*3']), 'Hard': (118, ['59/3*6', '6*59/3', '59*6/3', '6/3*59']), 'Extra': (849, ['9^3+5!', '3^6+5!', '5!+3^6', '5!+9^3'])}, '2024-11-30': {'Tiles': ['0', '1', '7', '9'], 'Easy': (8, ['9-1', '7+1', '1+7']), 'Medium': (69, ['70-1']), 'Hard': (102, ['109-7']), 'Extra': (916, ['917-0!'])}, '2024-12-01': {'Tiles': ['2', '5', '8', '9'], 'Easy': (1, ['9-8']), 'Medium': (84, ['89-5', '92-8']), 'Hard': (137, ['5*29-8', '29*5-8']), 'Extra': (132, ['5*8+92', '8*5+92', '92+5*8', '92+8*5'])}, '2024-12-02': {'Tiles': ['1', '2', '3', '4'], 'Easy': (18, ['21-3']), 'Medium': (85, ['2*43-1', '43*2-1', '41*2+3', '2*41+3', '3+2*41', '3+41*2']), 'Hard': (141, ['143-2']), 'Extra': (642, ['214*3', '3*214'])}, '2024-12-03': {'Tiles': ['2', '5', '6', '9'], 'Easy': (4, ['6-2', '9-5']), 'Medium': (32, ['5*6+2', '6*5+2', '2+5*6', '2+6*5']), 'Hard': (157, ['62+95', '92+65', '95+62', '65+92']), 'Extra': (730, ['2*5+6!', '5*2+6!', '6!+2*5', '6!+5*2'])}, '2024-12-04': {'Tiles': ['2', '3', '4', '7'], 'Easy': (12, ['4*3', '3*4']), 'Medium': (49, ['42+7', '2+47', '47+2', '7+42']), 'Hard': (133, ['42*3+7', '3*42+7', '7+3*42', '7+42*3']), 'Extra': (111, ['4*27+3', '74*3/2', '3/2*74', '3*74/2', '74/2*3', '27*4+3', '3+27*4', '3+4*27'])}, '2024-12-05': {'Tiles': ['0', '2', '6', '9'], 'Easy': (14, ['20-6']), 'Medium': (89, ['29+60', '20+69', '60+29', '69+20']), 'Hard': (197, ['206-9']), 'Extra': (400, ['60^2/9'])}, '2024-12-06': {'Tiles': ['1', '2', '4', '8'], 'Easy': (5, ['4+1', '1+4']), 'Medium': (96, ['8*12', '12*8', '2*48', '48*2']), 'Hard': (132, ['8+124', '124+8', '4+128', '128+4']), 'Extra': (193, ['4!*8+1', '24*8+1', '8*4!+1', '8*24+1', '1+24*8', '1+4!*8', '1+8*24', '1+8*4!'])}, '2024-12-07': {'Tiles': ['2', '5', '7', '9'], 'Easy': (3, ['5-2']), 'Medium': (54, ['79-25']), 'Hard': (149, ['92+57', '52+97', '97+52', '57+92']), 'Extra': (640, ['2^7*5', '5*2^7'])}, '2024-12-08': {'Tiles': ['2', '4', '6', '8'], 'Easy': (14, ['6+8', '8+6']), 'Medium': (60, ['2*6+48', '6*2+48', '48+2*6', '48+6*2', '62-8/4', '64-8/2', '68-2*4', '68-4*2']), 'Hard': (100, ['46*2+8', '2*46+8', '8+2*46', '8+46*2']), 'Extra': (706, ['4!+682', '682+4!'])}, '2024-12-09': {'Tiles': ['0', '1', '7', '8'], 'Easy': (3, ['10-7']), 'Medium': (55, ['8*7-1', '7*8-1']), 'Hard': (162, ['170-8']), 'Extra': (561, ['8*70+1', '7*80+1', '70*8+1', '80*7+1', '1+70*8', '1+7*80', '1+80*7', '1+8*70'])}, '2024-12-10': {'Tiles': ['3', '4', '5', '7'], 'Easy': (12, ['4*3', '7+5', '5+7', '3*4']), 'Medium': (49, ['53-4']), 'Hard': (153, ['4*37+5', '37*4+5', '5+37*4', '5+4*37']), 'Extra': (184, ['4^3+5!', '5!+4^3'])}, '2024-12-11': {'Tiles': ['1', '3', '6', '9'], 'Easy': (18, ['3*6', '6*3']), 'Medium': (68, ['69-1']), 'Hard': (166, ['169-3']), 'Extra': (111, ['13*9-6', '19*6-3', '6*19-3', '9*13-6'])}, '2024-12-12': {'Tiles': ['2', '3', '6', '9'], 'Easy': (12, ['3+9', '9+3', '6*2', '2*6']), 'Medium': (34, ['36-2']), 'Hard': (198, ['396/2']), 'Extra': (209, ['69*3+2', '3*69+2', '2+3*69', '2+69*3'])}, '2024-12-13': {'Tiles': ['2', '4', '7', '8'], 'Easy': (11, ['4+7', '7+4']), 'Medium': (57, ['84-27']), 'Hard': (110, ['7*4+82', '4*7+82', '82+4*7', '82+7*4']), 'Extra': (252, ['2^8-4'])}, '2024-12-14': {'Tiles': ['2', '5', '6', '8'], 'Easy': (13, ['5+8', '8+5']), 'Medium': (83, ['85-2']), 'Hard': (111, ['85+26', '86+25', '26+85', '25+86']), 'Extra': (376, ['2^8+5!', '5!+2^8'])}, '2024-12-15': {'Tiles': ['1', '5', '8', '9'], 'Easy': (10, ['1+9', '9+1']), 'Medium': (57, ['58-1']), 'Hard': (113, ['95+18', '15+98', '18+95', '98+15']), 'Extra': (473, ['59*8+1', '8*59+1', '1+59*8', '1+8*59'])}, '2024-12-16': {'Tiles': ['4', '7', '8', '9'], 'Easy': (2, ['9-7', '8/4']), 'Medium': (25, ['4*8-7', '8*4-7']), 'Hard': (117, ['7*4+89', '4*7+89', '89+4*7', '89+7*4']), 'Extra': (639, ['7!/8+9', '9+7!/8'])}, '2024-12-17': {'Tiles': ['0', '1', '4', '9'], 'Easy': (8, ['9-1']), 'Medium': (39, ['40-1']), 'Hard': (105, ['109-4']), 'Extra': (492, ['0!+491', '491+0!'])}, '2024-12-18': {'Tiles': ['2', '3', '7', '9'], 'Easy': (16, ['9+7', '7+9']), 'Medium': (66, ['93-27', '37+29', '27+39', '7*9+3', '29+37', '39+27', '9*7+3', '3+7*9', '3+9*7']), 'Hard': (197, ['97*2+3', '2*97+3', '3+2*97', '3+97*2']), 'Extra': (647, ['7*92+3', '92*7+3', '3+7*92', '3+92*7'])}, '2024-12-19': {'Tiles': ['0', '2', '4', '6'], 'Easy': (3, ['6/2']), 'Medium': (92, ['2*46', '46*2']), 'Hard': (155, ['620/4']), 'Extra': (124, ['2*60+4', '60*2+4', '6*20+4', '20*6+4', '4+20*6', '4+2*60', '4+60*2', '4+6*20'])}, '2024-12-20': {'Tiles': ['1', '5', '6', '9'], 'Easy': (4, ['5-1', '9-5']), 'Medium': (55, ['56-1']), 'Hard': (149, ['16*9+5', '9*16+5', '5+16*9', '5+9*16']), 'Extra': (845, ['5*169', '169*5'])}, '2024-12-21': {'Tiles': ['0', '2', '3', '9'], 'Easy': (5, ['3+2', '2+3']), 'Medium': (59, ['20+39', '29+30', '30+29', '39+20']), 'Hard': (135, ['3/2*90', '30*9/2', '90/2*3', '9*30/2', '3*90/2', '9/2*30', '30/2*9', '90*3/2']), 'Extra': (183, ['2*90+3', '90*2+3', '20*9+3', '9*20+3', '3+20*9', '3+2*90', '3+90*2', '3+9*20'])}, '2024-12-22': {'Tiles': ['4', '6', '8', '9'], 'Easy': (1, ['9-8']), 'Medium': (66, ['8*9-6', '9*8-6']), 'Hard': (117, ['48+69', '69+48', '49+68', '68+49']), 'Extra': (350, ['4*89-6', '89*4-6'])}, '2024-12-23': {'Tiles': ['4', '7', '8', '9'], 'Easy': (12, ['8+4', '4+8']), 'Medium': (57, ['8+49', '48+9', '49+8', '9+48']), 'Hard': (146, ['9*8+74', '8*9+74', '74+8*9', '74+9*8']), 'Extra': (367, ['8*47-9', '47*8-9'])}, '2024-12-24': {'Tiles': ['2', '5', '6', '8'], 'Easy': (10, ['2+8', '5*2', '2*5', '8+2']), 'Medium': (57, ['62-5', '65-8']), 'Hard': (104, ['2*56-8', '56*2-8']), 'Extra': (146, ['5!+26', '26+5!'])}, '2024-12-25': {'Tiles': ['1', '4', '5', '7'], 'Easy': (12, ['5+7', '7+5']), 'Medium': (32, ['47-15']), 'Hard': (197, ['51*4-7', '4*51-7']), 'Extra': (705, ['15*47', '47*15'])}, '2024-12-26': {'Tiles': ['0', '4', '5', '8'], 'Easy': (3, ['8-5']), 'Medium': (52, ['8/4+50', '50+8/4']), 'Hard': (192, ['4*50-8', '40*5-8', '50*4-8', '5*40-8']), 'Extra': (160, ['5!+40', '40+5!'])}, '2024-12-27': {'Tiles': ['0', '1', '3', '4'], 'Easy': (6, ['10-4']), 'Medium': (29, ['30-1']), 'Hard': (137, ['140-3']), 'Extra': (286, ['310-4!'])}, '2024-12-28': {'Tiles': ['1', '4', '5', '7'], 'Easy': (19, ['15+4', '5+14', '4+15', '14+5']), 'Medium': (42, ['47-5']), 'Hard': (125, ['51+74', '54+71', '71+54', '74+51']), 'Extra': (836, ['7*5!-4', '5!*7-4'])}, '2024-12-29': {'Tiles': ['0', '1', '3', '8'], 'Easy': (4, ['3+1', '1+3']), 'Medium': (78, ['81-3']), 'Hard': (105, ['108-3']), 'Extra': (125, ['10^3/8'])}, '2024-12-30': {'Tiles': ['0', '1', '4', '6'], 'Easy': (3, ['4-1']), 'Medium': (74, ['60+14', '64+10', '10+64', '14+60']), 'Hard': (101, ['40+61', '41+60', '61+40', '60+41']), 'Extra': (580, ['6!-140'])}, '2024-12-31': {'Tiles': ['4', '5', '7', '8'], 'Easy': (20, ['5*4', '4*5']), 'Medium': (55, ['48+7', '8+47', '7+48', '47+8']), 'Hard': (141, ['57+84', '87+54', '54+87', '84+57']), 'Extra': (317, ['4*78+5', '78*4+5', '5+4*78', '5+78*4'])}, '2025-01-01': {'Tiles': ['0', '1', '3', '4'], 'Easy': (5, ['4+1', '1+4']), 'Medium': (53, ['13+40', '10+43', '43+10', '40+13']), 'Hard': (121, ['40*3+1', '30*4+1', '3*40+1', '4*30+1', '1+30*4', '1+3*40', '1+40*3', '1+4*30']), 'Extra': (133, ['134-0!'])}, '2025-01-02': {'Tiles': ['2', '3', '4', '6'], 'Easy': (10, ['6+4', '4+6']), 'Medium': (54, ['324/6']), 'Hard': (141, ['6*24-3', '24*6-3']), 'Extra': (218, ['436/2', '6^3+2', '2+6^3'])}, '2025-01-03': {'Tiles': ['0', '1', '5', '6'], 'Easy': (12, ['60/5']), 'Medium': (46, ['56-10']), 'Hard': (144, ['150-6']), 'Extra': (299, ['6*50-1', '50*6-1', '60*5-1', '5*60-1'])}}

    puzzle = puzzles.get(today_str)

    if puzzle == None:
        puzzle = puzzles["2024-10-01"]

    date_of_first_puzzle = datetime.datetime.strptime("2024-07-25", "%Y-%m-%d").date()
    days_since_start = (today - date_of_first_puzzle).days

    # check if user has ever visited before:
    if "date_str" in request.session:

        # if user has already visited today, redirect to game play page:
        if request.session["date_str"] == today_str:
            return redirect("sumfing")

    # this is user's first visit today, so reset the session data
    current_time = time.time()
    request.session["difficulty"] = "Easy"
    request.session["puzzle"] = puzzle
    request.session["date_str"] = today_str
    request.session["game_no"] = days_since_start
    request.session["hints"] = ["-1", "-1", "-1", "-1"]
    return redirect("sumfing")


@csrf_protect
def sumfing(request):

    # redirect if the user has come here by entering route in browser, without starting a session
    if "date_str" not in request.session:
        return redirect("index")

    # get the session data, redirect if a problem
    try:
        puzzle = request.session["puzzle"]
        num_tiles = puzzle["Tiles"]
        difficulty = request.session["difficulty"]
    except:
        return redirect("index")

    # redirect if the game is finished
    if difficulty == "Completed":
        return redirect("completed")

    # render the puzzle page
    result = puzzle[difficulty][0]
    expressions = puzzle[difficulty][1]
    boxes = [tile for tile in expressions[0]]
    context = {
        "difficulty": difficulty.lower(),
        "num_tiles": num_tiles,
        "boxes": boxes,
        "result": result,
        "expressions": json.dumps(expressions),
    }
    return render(request, "sumfing.html", context)


@csrf_protect
def next_puzzle(request):

    # redirect if not here by form button
    if request.method != "POST":
        return redirect("index")

    # OK to move to next puzzle
    if "hints" not in request.session:
        request.session["hints"] = ["-1", "-1", "-1", "-1"]

    if "difficulty" not in request.session:
        request.session["difficulty"] = "unknown"

    current_difficulty = request.session["difficulty"]

    # keep track of how many hints were given
    hint_level = request.POST.get("hint_level")
    if current_difficulty == "Easy":
        request.session["hints"][0] = hint_level
    elif current_difficulty == "Medium":
        request.session["hints"][1] = hint_level
    elif current_difficulty == "Hard":
        request.session["hints"][2] = hint_level
    elif current_difficulty == "Extra":
        request.session["hints"][3] = hint_level

    # Update the difficulty level for the next puzzle
    if current_difficulty == "Easy":
        request.session["difficulty"] = "Medium"
    elif current_difficulty == "Medium":
        request.session["difficulty"] = "Hard"
    elif current_difficulty == "Hard":
        if request.session["hints"][0:3] == ["0", "0", "0"]:
            request.session["difficulty"] = "Extra"
        else:
            request.session["difficulty"] = "Completed"
    elif current_difficulty == "Extra":
        request.session["difficulty"] = "Completed"

    # If the puzzle completed
    if request.session["difficulty"] == "Completed":
        return redirect("completed")

    return sumfing(request)


def completed(request):

    # redirect if the user came here by browswer line
    if "difficulty" not in request.session:
        return redirect("index")

    if request.session["difficulty"] != "Completed":
        return redirect("index")

    # Make a message about how many hints have been given
    hints_given = request.session["hints"]
    hints_message = []
    for i in range(len(hints_given)):
        if hints_given[i] == "-1":
            result = None
        elif hints_given[i] == "0":
            result = "✅"
        elif hints_given[i] == "1":
            result = f"💡✅"
        elif hints_given[i] == "2":
            result = f"💡💡✅"
        elif hints_given[i] == "3":
            result = "❌"
        hints_message.append(result)

    game_no = request.session["game_no"]

    if hints_message[3] and hints_message[3] != "❌":
        html_message = f"Sumfing #{game_no}\n\nEasy: {hints_message[0]}\nMedium: {hints_message[1]}\nHard: {hints_message[2]}\nExtra🤓: {hints_message[3]}"
        whatsapp_message = f"Sumfing #{game_no}\nEasy: {hints_message[0]}\nMedium: {hints_message[1]}\nHard: {hints_message[2]}\nExtra🤓: {hints_message[3]}\nPlay at sumfing.com"
    else:
        html_message = f"Sumfing #{game_no}\n\nEasy: {hints_message[0]}\nMedium: {hints_message[1]}\nHard: {hints_message[2]}\n"
        whatsapp_message = f"Sumfing #{game_no}\nEasy: {hints_message[0]}\nMedium: {hints_message[1]}\nHard: {hints_message[2]}\nPlay at sumfing.com"

    # Make next game message:
    # 1. Get the current date and time
    now = datetime.datetime.now()
    # 2. Get the start of tomorrow
    tomorrow = (now + datetime.timedelta(days=1)).replace(
        hour=0, minute=0, second=0, microsecond=0
    )
    # 3. Calculate the time difference
    time_difference = tomorrow - now
    # 4. Convert the difference to hours and minutes
    total_seconds = time_difference.total_seconds()
    hours = int(total_seconds // 3600)
    minutes = int((total_seconds % 3600) // 60)
    # 5. Form the message string
    next_game_message = f"Sumfing else in\n{hours} hours and {minutes} minutes"

    context = {
        "html_message": html_message,
        "whatsapp_message": whatsapp_message,
        "next_game_message": next_game_message,
    }

    return render(request, "completed.html", context)
